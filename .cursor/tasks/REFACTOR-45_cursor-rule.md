# .cursor/rules/ 全体のリファクタリング・レビュー

イシュー #45: .cursor/rules/ 配下の全ルールファイルをレビューし、より明確で効果的なルールに改善する。

## Completed Tasks

- [x] cursor-tasks.mdcをレビュー・修正
- [x] 「質問による背景知識の確認」セクションを追加
- [x] global.mdcをレビュー・修正
- [x] git/issue.mdcをレビュー・修正
- [x] git/worktree.mdcをレビュー・修正（issue.mdcとの整合性）
- [x] git/commit.mdcをレビュー・修正
- [x] git/pr.mdcをレビュー（修正不要と判断）
- [x] git/merge-strategy.mdcをレビュー・修正
- [x] 全体の整合性チェックを完了
- [x] README.mdを簡潔化・リンクベースに修正
- [x] README.md と production-README.md の棲み分けを明確化
- [x] ファイル名を標準的な構成に変更（README.md ↔ DEVELOPMENT.md）

## In Progress Tasks

（なし）

## Future Tasks

（なし）

## Implementation Plan

### 目標

- .cursor/rules/ 配下の全ルールファイルを読みやすく、AIが理解しやすい形に改善
- ルールの重複や矛盾を解消
- 重要な原則を明確に強調

### 要件・制約事項

- **AI指示の原則に従う**: 確実性が必要な場合は具体的に、目的達成が重要な場合は抽象的に記述
- **重要セクションは強調**: 【重要】マークや引用ブロックで視覚的に明確化
- **目的志向**: 手段の列挙ではなく、達成すべき状態や判断基準を示す
- **既存のルール構造は維持**: 大幅な変更ではなく、改善とリファクタリング

### 検討事項・議論ログ

#### cursor-tasks.mdcのレビュー

**修正内容**:
1. **AI指示の原則を新設**: 「確実性が必要な場合は具体的に、目的達成が重要な場合は抽象的に」という基本原則を明文化
2. **AIの振る舞いと責任を最上部に移動**: 最も重要な内容なので、フォルダ構成より先に配置
3. **重要セクションに【重要】マーク追加**: 視覚的な強調（パターン4を採用）
4. **目的志向の記述に変更**: 
   - 「記録すべき内容」の詳細な列挙 → 「達成すべき状態」と「判断基準」に変更
   - 「タスクファイル更新のタイミング」の詳細な列挙 → シンプルな原則に統合
5. **重複削除とシンプル化**: 
   - タスクサイクルの図解を追加
   - 重複していた内容を統合
   - ✅絵文字や不要なセクションを削除

**採用した強調パターン**:
```markdown
## 【重要】セクション名

> **このセクションは最優先で理解してください**
> 
> セクションの役割と重要性の説明
```

#### global.mdcのレビュー

**修正内容**:
1. **ファイルの目的を明確化**: 「AI向けナビゲーション」として、ルールシステム全体を俯瞰する役割を明示
2. **ルールシステムの構造を追加**: 各ルールファイルの役割と参照タイミングを整理
   - コアルール（常に意識すべき）
   - Git関連ルール（Git操作時に参照）
3. **merge-strategy.mdcのリンクを追加**: 欠けていたリンクを補完
4. **開発フローを図解化**: 文章ベースから視覚的な図解に変更（GitHub/Localの区別、各ステップでのルール参照）
5. **不要なセクションを削除**: 「イシュー・ブランチ・タスクファイルの対応」「高度な使い方: 並列開発」を削除（詳細は各ルールに任せる）

**設計方針**:
- global.mdcは「ナビゲーションハブ」として維持
- 詳細は各ルールファイルに任せ、ここは構造と全体像の把握に専念
- alwaysApply: trueの価値を最大化（AIが常にルール体系を把握）

#### git/issue.mdcのレビュー

**修正内容**:
1. **description生成支援を完全削除**: ユーザーの要望により、AIによるイシューdescription生成機能を削除
   - 概要から「description生成」を削除
   - AI支援の範囲から「イシューのdescription生成」を削除
   - 基本フローから関連ステップを削除
   - 「Description生成」セクション全体を削除
2. **worktree作成に特化**: 「ブランチ作成」→「worktree作成」に統一
3. **通常のブランチオプションを削除**: worktreeをデフォルトとし、通常のブランチ作成オプションを削除
4. **具体例を2つに削減**: ブランチ名生成の例を簡潔化
5. **タスクファイル作成時のユーザー確認を追加**: 
   - worktree作成後、必ずユーザーに「タスクファイルも作成しますか？」と確認
   - 承認された場合のみ、worktreeディレクトリ配下の `.cursor/tasks/` に作成
   - 勝手にタスクファイルを作成しないよう明示

**設計方針**:
- issue.mdcはworktree作成とタスクファイル作成の初期セットアップに専念
- description生成は手動で行う（AI支援対象外）
- ユーザー確認を徹底し、予期しないファイル作成を防止

#### git/worktree.mdcのレビュー

**修正内容**:
1. **ディレクトリ構造を簡潔化**: 冗長な説明を削除し、必要最小限の構造のみ記載
   - `main/` と `worktrees/` の各worktreeディレクトリにコメントで説明を追加
   - `.git`ファイルやSubmodule方式の詳細説明を削除
2. **worktreeの説明を簡素化**: 「各worktreeでCursorを開けば、それぞれ独立した環境として動作します」のみに簡素化
3. **Submodule方式のセクションを削除**: 最新の構成（直接ルールをリポジトリに含む方式）に合わせて削除
4. **命名規則を上部に移動**: 重要な情報として独立した見出しにし、ベストプラクティスから分離
5. **不要なコマンド例を削除**: 
   - `cursor` コマンドの例
   - `git worktree list` の出力例
   - `git worktree prune` コマンド
6. **AI駆動開発セクションを削除**: 冗長なユースケース説明を削除
7. **イシューワークフローとの統合を簡潔化**: `@git/issue.mdc` への参照のみに変更
8. **cursor-tasksとの統合セクションを削除**: 不要な詳細説明を削除
9. **ベストプラクティスセクションを削除**: 注意点のみを残し、冗長なベストプラクティスを削除

**設計方針**:
- worktree.mdcは必要最小限の情報に絞り、明確で簡潔なドキュメントに
- issue.mdcに詳細なワークフローを記載し、worktree.mdcは技術的なリファレンスに徹する
- Submodule方式から直接含める方式への移行に伴う更新

#### git/commit.mdcのレビュー

**修正内容**:
1. **基本構造をシンプル化**: `<type>: <description>` のみに簡素化
   - scope、body、footerを削除（運用上冗長だったため）
2. **Breaking Changeセクションを削除**: 不要と判断
3. **例をシンプルな形式に修正**: scopeなしのシンプルな例に統一
4. **コミットタイミングの判断セクションを削除**: AIに柔軟性を持たせるため
5. **コミット実行手順セクションを削除**: 柔軟な運用のため（全ファイルをaddすべきでないケースがあるため）
6. **AIによるコミットメッセージ作成ルールを追加**: diff確認→メッセージ生成の基本ルールを明記
7. **参考リンクを整理**: Conventional Commitsのみ残し、他は削除

**設計方針**:
- コミットメッセージの規約だけに焦点を当て、運用面はAIの判断に任せる
- シンプルで実用的な形式に統一

#### git/merge-strategy.mdcのレビュー

**修正内容**:
1. **squash merge前提を明記**: ドキュメントの冒頭でsquash mergeを使う前提を説明
2. **問題の説明を具体化**: なぜsquash merge後に問題が発生するのかを図解で説明
3. **リセット戦略に焦点**: 戦略1（リセット戦略）のみに絞り、シンプルで明確に
4. **stashを手順に組み込み**: 注意点ではなく基本手順に含めることで、使いやすく
5. **冗長な説明を削除**: 
   - 「なぜこの方法を推奨するのか」を簡潔化
   - 具体例セクションを削除
   - 親子階層の例を削除
   - 未プッシュのコミット確認を削除
   - 何度もPRを出す場合の対処法を削除
   - AIによるサポートセクションを削除
6. **必要最小限の情報に絞る**: 手順と注意点のみ記載

**設計方針**:
- squash merge + タスクファイル継承という特定の運用に特化
- 必要最小限の情報に絞り、シンプルで読みやすく
- 1つの推奨戦略（リセット戦略）を明確に提示

#### 全体の整合性チェック（最終確認）

**実施内容**:
1. 全7ファイルを包括的にレビュー
2. 以下の観点でチェック：
   - 内部リンク・参照の整合性
   - ファイル間の矛盾
   - 命名規則の一貫性
   - フロントマター（YAML）の統一
   - 関連ドキュメントセクションの完備
   - 開発フローの整合性

**検出・修正した問題**:
1. **global.mdc**: `git/issue.mdc` の説明を「イシューdescription作成」→「worktree・タスクファイル作成支援」に修正
2. **global.mdc**: 開発フローを修正（description作成ステップを削除、worktree・タスクファイル作成を1ステップに統合）
3. **git/merge-strategy.mdc**: バッククォートを削除して他ファイルと統一（`` `@xxx.mdc` `` → `@xxx.mdc`）
4. **git/issue.mdc**: 「手動でブランチ・descriptionを作成した場合」→「手動でworktreeを作成した場合」に修正
5. **git/commit.mdc**: 関連ドキュメントセクションを追加（一貫性のため）
6. **git/pr.mdc**: 関連ドキュメントセクションを追加（一貫性のため）
7. **git/merge-strategy.mdc**: フロントマターを `title:` → `description:` に統一

**最終確認結果**:
- ✅ すべての内部リンク（@xxx.mdc）が有効
- ✅ ファイル間の矛盾なし
- ✅ 命名規則が統一
- ✅ フロントマターが統一（すべて `description:` + `alwaysApply:`）
- ✅ 関連ドキュメントセクションがすべてのファイルに存在
- ✅ 開発フローが各ルールの内容と一致
- ✅ Linterエラーなし

#### README.mdの簡潔化

**実施内容**:
READMEを大幅に簡潔化し、リンクベースの構成に変更

**変更内容**:
1. **行数削減**: 250行 → 83行（67%削減）
2. **冗長な内容を削除**:
   - 詳細な開発フロー → global.mdcへ
   - git worktreeの詳細・ディレクトリ構造 → git/worktree.mdcへ
   - 命名規則の詳細 → cursor-tasks.mdcへ
   - タスクファイルの構造 → cursor-tasks.mdcへ
   - 「パターン1」「パターン2」の冗長な分類 → クイックスタートに統合
3. **description生成への言及を削除**: 最新のルール（description生成機能削除済み）に合わせる
4. **新しい構成**:
   - 特徴（4項目）
   - クイックスタート（5ステップ）
   - ドキュメント（リンク集：コアルール2 + Git関連ルール5）
   - 他のプロジェクトでの使用（簡潔版）
   - 参考（1項目）

**設計方針**:
- README = エントリーポイント（何をするか、どう始めるか）
- 詳細 = ルールファイル（すべて `.cursor/rules/` へのリンク）
- DRY原則（重複を徹底排除）

#### README.md と production-README.md の棲み分け

**問題認識**:
- README.mdに「cursor-rulesの使い方」を記載していた → 本来はエンドユーザー向けの内容
- production-README.mdは「インストール方法」のみ → 使い方やコンセプトが不足

**修正内容**:

1. **README.md（開発者向け）**:
   - このリポジトリの目的
   - ブランチ戦略（main vs production）
   - 開発セットアップ
   - 開発フロー
   - ディレクトリ構造
   - 貢献方法
   - エンドユーザー向けドキュメントへのリンク

2. **production-README.md（エンドユーザー向け）**:
   - cursor-rulesの特徴
   - クイックスタート（6ステップ）
   - インストール方法
   - ドキュメント（ルールファイルのリンク）
   - 更新方法
   - トラブルシューティング

**設計方針**:
- README.md = このリポジトリの開発者向け（cursor-rulesを改善・貢献する人）
- production-README.md = エンドユーザー向け（cursor-rulesを使う人）
- 明確に分離し、相互参照で補完

#### ファイル名の標準化

**問題認識**:
- `production-README.md` というファイル名が非標準的
- ブランチ名（production）という実装詳細が露出
- 一般的なOSSプロジェクトとの乗離

**検討**:
1. **一般的な慣習調査**: README.mdは常にエンドユーザー向けが標準
2. **ブランチ戦略**: productionをデフォルトにする案も検討したが、開発フローへの影響を考慮
3. **最終決定**: mainのREADME.mdをエンドユーザー向けに（DEVELOPMENT.mdを開発者向けに）

**実装内容**:

1. **ファイルリネーム**:
   - `README.md` → `DEVELOPMENT.md`（開発者向け）
   - `production-README.md` → `README.md`（エンドユーザー向け）

2. **README.mdに開発者向けリンク追加**:
   - 絶対パス使用（productionブランチにはDEVELOPMENT.mdが存在しないため）
   - `https://github.com/nobunosuke/cursor-rules/blob/main/DEVELOPMENT.md`

3. **GitHub Action簡素化**:
   - `production-README.md` → `README.md` のリネーム処理が不要に
   - README.mdをそのままコピー

4. **DEVELOPMENT.mdの参照更新**:
   - `production-README.md` → `README.md` へのリンク修正

**メリット**:
- ✅ 一般的な慣習に完全準拠
- ✅ GitHub訪問者が最初にエンドユーザー向けを見る
- ✅ GitHub Actionがシンプルに
- ✅ ファイル名が役割を明確に表現

### 決定事項

- cursor-tasks.mdcは修正完了
- 「質問による背景知識の確認」セクションを追加：AIはすぐ実装を始めるのではなく、まず質問してユーザーから背景知識を取りに行く姿勢を持つべき
- global.mdcは修正完了：ナビゲーションハブとして刷新、図解化で視認性向上
- 各ファイルを個別にレビュー → 全体の整合性確認の順で進める
- git/issue.mdcは修正完了：description生成支援を削除、worktree作成に特化、タスクファイル作成時のユーザー確認を追加
- git/worktree.mdcの基本フローセクションを修正：issue.mdcとの整合性を確保
- git/commit.mdcは修正完了：シンプルな `<type>: <description>` 形式に統一、AIによるコミットメッセージ作成の基本ルールを追加
- git/pr.mdcはレビュー完了：現状の内容で適切であり、修正不要と判断
- git/merge-strategy.mdcは修正完了：squash merge前提を明記、リセット戦略のみに焦点、stashを手順に組み込み、補足セクション削除

### アーキテクチャ

（特記事項なし）

### データフロー

（特記事項なし）

### その他

- 参照ファイル `ref-REFACTOR-45_emphasis-patterns.md` を作成（強調表現のパターン案）
- パターン4を採用したため、参照ファイルは保持

## Relevant Files

- .cursor/rules/cursor-tasks.mdc - タスク管理ルール（修正完了）
- .cursor/rules/global.mdc - グローバルルール（修正完了：ナビゲーションハブ化）
- .cursor/rules/git/issue.mdc - イシュールール（修正完了：worktree作成に特化）
- .cursor/rules/git/worktree.mdc - worktreeルール（修正完了：簡潔化）
- .cursor/rules/git/commit.mdc - コミットルール（修正完了：シンプル化）
- .cursor/rules/git/pr.mdc - PRルール（修正完了：関連ドキュメント追加）
- .cursor/rules/git/merge-strategy.mdc - マージ戦略（修正完了：squash merge前提）
- README.md - エンドユーザー向けドキュメント（修正完了：使い方中心、標準的な構成に）
- DEVELOPMENT.md - 開発者向けドキュメント（修正完了：開発者向けに再構成）
- .github/workflows/sync-production.yml - GitHub Action（修正完了：シンプル化）
- .cursor/tasks/ref/ref-REFACTOR-45_squash-merge-strategies.md - マージ戦略の比較・検討資料

